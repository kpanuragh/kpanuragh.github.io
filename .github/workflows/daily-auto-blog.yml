name: Daily Auto-Generate Blog Posts

on:
  # Run daily at 11 AM UTC
  schedule:
    - cron: '0 11 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      count:
        description: 'Number of blog posts to generate (1-4)'
        required: false
        type: string
        default: '2'

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  pages: write

jobs:
  generate-security-blog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check for existing security blog today
        id: check_existing
        run: |
          TODAY=$(date +%Y-%m-%d)
          if ls content/posts/${TODAY}-*security*.md 2>/dev/null | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Security blog already exists for today, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Security Blog Post
        if: steps.check_existing.outputs.exists != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Generate a fun, engaging blog post about **Cybersecurity** or **Web Security**.

            **CRITICAL: AVOID DUPLICATES**
            1. First, check all existing posts in `content/posts/` directory
            2. Look for posts with similar topics, especially from the last 7 days
            3. If you find similar topics (e.g., multiple JWT posts, multiple XSS posts), choose a COMPLETELY DIFFERENT topic
            4. List the recent topics you found and explicitly state your chosen topic is different

            **IMPORTANT STYLE REQUIREMENTS:**
            - Read `content/posts/common-web-vulnerabilities.md` as a style reference
            - Match the exact conversational, funny tone
            - Use emojis in headings (üîí üõ°Ô∏è üíâ üéØ etc.)
            - Keep it relatable with humor and analogies
            - Short paragraphs, easy to scan
            - Only minimal, essential code examples
            - Include "Real Talk" or "Pro Tip" sections

            **Steps:**
            1. Check existing posts to avoid duplicate topics
            2. Run `npm run fetch-trends` to see current security topics
            3. Pick ONE specific security topic that hasn't been covered recently (e.g., "API Security", "OWASP Top 10", "Docker Security", "CORS", "SQL Injection", etc.)
            4. Write 800-1000 words in the EXACT style of existing posts

            **Format:**
            - Title: "[Catchy Title with Emoji] üîí"
            - Date: "2026-01-21"
            - Tags: ["cybersecurity", "web-security", "security", plus 1-2 specific tags]
            - Filename: `2026-01-21-[slug].md` in `content/posts/`

            **Must include:**
            - Funny opening line
            - Practical examples
            - Good vs Bad code comparisons
            - Analogies that make it relatable
            - TL;DR or conclusion with links to LinkedIn/GitHub

            After creating, commit with: "feat: Security blog - [title]" and push!

          # Allow necessary tools for blog generation
          claude_args: |
            --allowedTools "Bash,Write,Read,Grep,Edit"

  generate-laravel-blog:
    runs-on: ubuntu-latest
    needs: generate-security-blog
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Check for existing Laravel blog today
        id: check_existing
        run: |
          TODAY=$(date +%Y-%m-%d)
          if ls content/posts/${TODAY}-*laravel*.md 2>/dev/null | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Laravel blog already exists for today, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Laravel Blog Post
        if: steps.check_existing.outputs.exists != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Generate a fun, engaging blog post about **Laravel or PHP development**.

            **CRITICAL: AVOID DUPLICATES**
            1. First, check all existing posts in `content/posts/` directory
            2. Look for Laravel/PHP posts with similar topics, especially from the last 7 days
            3. If you find similar topics (e.g., multiple validation posts, multiple Eloquent posts), choose a COMPLETELY DIFFERENT topic
            4. List the recent Laravel topics you found and explicitly state your chosen topic is different

            **IMPORTANT STYLE REQUIREMENTS:**
            - Read `content/posts/laravel-performance-tips.md` as a style reference
            - Match the exact conversational, funny tone
            - Use emojis in headings (üöÄ üí® ‚ö° üéØ etc.)
            - Keep it relatable with humor and analogies
            - Short paragraphs, easy to scan
            - Only minimal, essential code examples
            - Include "Real Talk" or "Pro Tip" sections

            **Steps:**
            1. Check existing posts to avoid duplicate topics
            2. Run `npm run fetch-trends` to see current Laravel/PHP topics
            3. Pick ONE specific Laravel topic that hasn't been covered recently (e.g., "Laravel Tips", "Eloquent Tricks", "API Best Practices", "Testing", "Queue Jobs", "Middleware", etc.)
            4. Write 800-1000 words in the EXACT style of existing posts

            **Format:**
            - Title: "[Catchy Title with Emoji] üöÄ"
            - Date: "2026-01-21"
            - Tags: ["laravel", "php", "web-dev", plus 1-2 specific tags]
            - Filename: `2026-01-21-[slug].md` in `content/posts/`

            **Must include:**
            - Funny opening line
            - Practical examples with before/after code
            - Relatable analogies
            - Bonus tips section
            - TL;DR or conclusion with links

            After creating, commit with: "feat: Laravel blog - [title]" and push!

          # Allow necessary tools for blog generation
          claude_args: |
            --allowedTools "Bash,Write,Read,Grep,Edit"

  generate-rust-blog:
    runs-on: ubuntu-latest
    needs: generate-laravel-blog
    if: ${{ github.event.inputs.count >= '3' || github.event_name == 'schedule' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Check for existing Rust blog today
        id: check_existing
        run: |
          TODAY=$(date +%Y-%m-%d)
          if ls content/posts/${TODAY}-*rust*.md 2>/dev/null | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Rust blog already exists for today, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Rust/Systems Programming Blog Post
        if: steps.check_existing.outputs.exists != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Generate a fun, engaging blog post about **Rust, Systems Programming, or Performance**.

            **CRITICAL: AVOID DUPLICATES**
            1. First, check all existing posts in `content/posts/` directory
            2. Look for Rust/systems posts with similar topics, especially from the last 7 days
            3. If you find similar topics, choose a COMPLETELY DIFFERENT topic
            4. List the recent Rust topics you found and explicitly state your chosen topic is different

            **IMPORTANT STYLE REQUIREMENTS:**
            - Read existing posts in `content/posts/` as style references
            - Match the exact conversational, funny tone
            - Use emojis in headings (ü¶Ä ‚ö° üöÄ üî• etc.)
            - Keep it relatable with humor and analogies
            - Short paragraphs, easy to scan
            - Only minimal, essential code examples
            - Make Rust accessible to non-Rust developers

            **Steps:**
            1. Check existing posts to avoid duplicate topics
            2. Run `npm run fetch-trends` to see current Rust/systems topics
            3. Pick ONE specific topic that hasn't been covered recently (e.g., "Why Rust", "Memory Safety", "Rust for Web", "Learning Rust", "Performance Optimization", etc.)
            4. Write 800-1000 words in the EXACT style of existing posts

            **Format:**
            - Title: "[Catchy Title with Emoji] ü¶Ä"
            - Date: "2026-01-21"
            - Tags: ["rust", "systems-programming", "performance", plus 1-2 specific tags]
            - Filename: `2026-01-21-[slug].md` in `content/posts/`

            **Must include:**
            - Funny opening line
            - Why developers should care
            - Comparisons with other languages
            - Practical examples
            - TL;DR or conclusion

            After creating, commit with: "feat: Rust blog - [title]" and push!

          # Allow necessary tools for blog generation
          claude_args: |
            --allowedTools "Bash,Write,Read,Grep,Edit"

  generate-opensource-blog:
    runs-on: ubuntu-latest
    needs: generate-rust-blog
    if: ${{ github.event.inputs.count >= '4' || github.event_name == 'schedule' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Check for existing Open Source blog today
        id: check_existing
        run: |
          TODAY=$(date +%Y-%m-%d)
          if ls content/posts/${TODAY}-*open*source*.md content/posts/${TODAY}-*opensource*.md content/posts/${TODAY}-*github*.md 2>/dev/null | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Open Source blog already exists for today, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Open Source Blog Post
        if: steps.check_existing.outputs.exists != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Generate a fun, engaging blog post about **Open Source, GitHub, or Developer Tools**.

            **CRITICAL: AVOID DUPLICATES**
            1. First, check all existing posts in `content/posts/` directory
            2. Look for open source/GitHub posts with similar topics, especially from the last 7 days
            3. If you find similar topics, choose a COMPLETELY DIFFERENT topic
            4. List the recent open source topics you found and explicitly state your chosen topic is different

            **IMPORTANT STYLE REQUIREMENTS:**
            - Read existing posts in `content/posts/` as style references
            - Match the exact conversational, funny tone
            - Use emojis in headings (üåç üöÄ üíª üéâ etc.)
            - Keep it relatable with humor and analogies
            - Short paragraphs, easy to scan
            - Focus on community and contribution stories

            **Steps:**
            1. Check existing posts to avoid duplicate topics
            2. Run `npm run fetch-trends` to see trending open source projects
            3. Pick ONE specific topic that hasn't been covered recently (e.g., "Getting Started with Open Source", "Cool GitHub Projects", "Maintainer Stories", "Contributing Guide", etc.)
            4. Write 800-1000 words in the EXACT style of existing posts

            **Format:**
            - Title: "[Catchy Title with Emoji] üåç"
            - Date: "2026-01-21"
            - Tags: ["open-source", "github", "community", plus 1-2 specific tags]
            - Filename: `2026-01-21-[slug].md` in `content/posts/`

            **Must include:**
            - Funny opening line
            - Personal stories or examples
            - Specific projects/tools to check out
            - How to get involved
            - TL;DR or conclusion

            After creating, commit with: "feat: Open source blog - [title]" and push!

          # Allow necessary tools for blog generation
          claude_args: |
            --allowedTools "Bash,Write,Read,Grep,Edit"
