name: Daily Auto-Generate Blog Posts

on:
  # Run daily at 11 AM UTC
  schedule:
    - cron: '0 11 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      count:
        description: 'Number of blog posts to generate (1-4)'
        required: false
        type: string
        default: '2'

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  pages: write

jobs:
  generate-security-blog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check for existing security blog today
        id: check_existing
        run: |
          TODAY=$(date +%Y-%m-%d)
          if ls content/posts/${TODAY}-*security*.md 2>/dev/null | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Security blog already exists for today, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Security Blog Post
        if: steps.check_existing.outputs.exists != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Generate a fun, engaging blog post about **Cybersecurity** or **Web Security**.

            **AUTHOR CONTEXT - Write as Anuragh K P:**
            - Technical Lead with 7+ years experience building scalable web applications
            - Expert in Laravel, AWS, Node.js - architected serverless e-commerce backends
            - Security enthusiast and active in security communities (passion)
            - Explores RF/SDR security in spare time (hobby)
            - Write from FIRST-PERSON perspective sharing practical experiences
            - Include phrases like "In my experience building production systems...", "As someone passionate about security...", "In security communities, we often discuss..."

            **CRITICAL: AVOID DUPLICATES**
            1. First, use Glob to list all existing posts in `content/posts/` directory
            2. Look for posts with similar topics, especially from the last 7 days
            3. If you find similar topics (e.g., multiple JWT posts, multiple XSS posts), choose a COMPLETELY DIFFERENT topic
            4. List the recent topics you found and explicitly state your chosen topic is different

            **IMPORTANT STYLE REQUIREMENTS:**
            - Read `content/posts/common-web-vulnerabilities.md` as a style reference
            - Match the exact conversational, funny tone
            - Use emojis in headings (üîí üõ°Ô∏è üíâ üéØ etc.)
            - Keep it relatable with humor and analogies
            - Short paragraphs, easy to scan
            - Only minimal, essential code examples
            - Include "Real Talk" or "Pro Tip" sections
            - Share personal anecdotes from security research or community work

            **Steps:**
            1. Check existing posts to avoid duplicate topics
            2. Run `npm run fetch-trends` to see current security topics
            3. Pick ONE specific security topic that hasn't been covered recently (e.g., "API Security", "OWASP Top 10", "Docker Security", "CORS", "SQL Injection", "RF Security", "Bug Bounty Tips", etc.)
            4. Write 800-1000 words in the EXACT style of existing posts
            5. Use today's date (get it via `date +%Y-%m-%d` command)

            **Format:**
            - Title: "[Catchy Title with Emoji] üîí"
            - Date: Use TODAY'S date (run `date +%Y-%m-%d`)
            - Tags: ["cybersecurity", "web-security", "security", plus 1-2 specific tags]
            - Filename: `[TODAY]-[slug].md` in `content/posts/` where [TODAY] is today's date

            **Must include:**
            - Funny opening line
            - Personal experience or story from security research
            - Practical examples from real-world scenarios
            - Good vs Bad code comparisons
            - Analogies that make it relatable
            - TL;DR or conclusion with links to LinkedIn/GitHub

            **CRITICAL - Git Operations:**
            After creating the blog post, you MUST:
            1. Run `git add content/posts/[your-new-file].md`
            2. Run `git commit -m "feat: Security blog - [title]"`
            3. Run `git push origin main`

            Verify the push succeeds before completing!

          # Allow necessary tools for blog generation
          claude_args: |
            --allowedTools "Bash,Write,Read,Grep,Edit,Glob"

  generate-laravel-blog:
    runs-on: ubuntu-latest
    needs: generate-security-blog
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Check for existing Laravel blog today
        id: check_existing
        run: |
          TODAY=$(date +%Y-%m-%d)
          if ls content/posts/${TODAY}-*laravel*.md 2>/dev/null | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Laravel blog already exists for today, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Laravel Blog Post
        if: steps.check_existing.outputs.exists != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Generate a fun, engaging blog post about **Laravel or PHP development**.

            **AUTHOR CONTEXT - Write as Anuragh K P:**
            - Technical Lead with 7+ years professional experience in Laravel
            - Architected and deployed scalable, serverless e-commerce backends at Cubet Techno Labs
            - Expert in Laravel, AWS, Node.js - built production systems handling real traffic
            - Security-conscious developer who integrates security best practices
            - Open source contributor to PHP/Laravel ecosystem (passion)
            - Write from FIRST-PERSON perspective sharing real project experiences
            - Include phrases like "In production systems I've built...", "As a Technical Lead, I've learned...", "A pattern that saved us in a real project..."

            **CRITICAL: AVOID DUPLICATES**
            1. First, use Glob to list all existing posts in `content/posts/` directory
            2. Look for Laravel/PHP posts with similar topics, especially from the last 7 days
            3. If you find similar topics (e.g., multiple validation posts, multiple Eloquent posts), choose a COMPLETELY DIFFERENT topic
            4. List the recent Laravel topics you found and explicitly state your chosen topic is different

            **IMPORTANT STYLE REQUIREMENTS:**
            - Read `content/posts/laravel-performance-tips.md` as a style reference
            - Match the exact conversational, funny tone
            - Use emojis in headings (üöÄ üí® ‚ö° üéØ etc.)
            - Keep it relatable with humor and analogies
            - Short paragraphs, easy to scan
            - Only minimal, essential code examples
            - Include "Real Talk" or "Pro Tip" sections
            - Share lessons learned from real Laravel projects

            **Steps:**
            1. Check existing posts to avoid duplicate topics
            2. Run `npm run fetch-trends` to see current Laravel/PHP topics
            3. Pick ONE specific Laravel topic that hasn't been covered recently (e.g., "Laravel Tips", "Eloquent Tricks", "API Best Practices", "Testing", "Queue Jobs", "Middleware", "Security in Laravel", etc.)
            4. Write 800-1000 words in the EXACT style of existing posts
            5. Use today's date (get it via `date +%Y-%m-%d` command)

            **Format:**
            - Title: "[Catchy Title with Emoji] üöÄ"
            - Date: Use TODAY'S date (run `date +%Y-%m-%d`)
            - Tags: ["laravel", "php", "web-dev", plus 1-2 specific tags]
            - Filename: `[TODAY]-[slug].md` in `content/posts/` where [TODAY] is today's date

            **Must include:**
            - Funny opening line
            - Personal experience or lesson learned
            - Practical examples with before/after code
            - Relatable analogies
            - Bonus tips section
            - TL;DR or conclusion with links

            **CRITICAL - Git Operations:**
            After creating the blog post, you MUST:
            1. Run `git add content/posts/[your-new-file].md`
            2. Run `git commit -m "feat: Laravel blog - [title]"`
            3. Run `git push origin main`

            Verify the push succeeds before completing!

          # Allow necessary tools for blog generation
          claude_args: |
            --allowedTools "Bash,Write,Read,Grep,Edit,Glob"

  generate-rust-blog:
    runs-on: ubuntu-latest
    needs: generate-laravel-blog
    if: ${{ github.event.inputs.count >= '3' || github.event_name == 'schedule' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Check for existing Rust blog today
        id: check_existing
        run: |
          TODAY=$(date +%Y-%m-%d)
          if ls content/posts/${TODAY}-*rust*.md 2>/dev/null | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Rust blog already exists for today, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Rust/Systems Programming Blog Post
        if: steps.check_existing.outputs.exists != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Generate a fun, engaging blog post about **Rust, Systems Programming, or Performance**.

            **AUTHOR CONTEXT - Write as Anuragh K P:**
            - Technical Lead with 7+ years in Laravel/Node.js, now exploring Rust
            - RF/SDR hobbyist where systems programming and performance matter
            - Security enthusiast - memory safety in Rust is exciting from this perspective
            - Learning Rust journey - relatable to developers coming from web background
            - Write from FIRST-PERSON perspective as an experienced dev exploring Rust
            - Include phrases like "Coming from 7 years of Laravel/Node.js...", "What excited me about Rust...", "For my RF/SDR hobby projects, I needed..."

            **CRITICAL: AVOID DUPLICATES**
            1. First, use Glob to list all existing posts in `content/posts/` directory
            2. Look for Rust/systems posts with similar topics, especially from the last 7 days
            3. If you find similar topics, choose a COMPLETELY DIFFERENT topic
            4. List the recent Rust topics you found and explicitly state your chosen topic is different

            **IMPORTANT STYLE REQUIREMENTS:**
            - Read existing posts in `content/posts/` as style references
            - Match the exact conversational, funny tone
            - Use emojis in headings (ü¶Ä ‚ö° üöÄ üî• etc.)
            - Keep it relatable with humor and analogies
            - Short paragraphs, easy to scan
            - Only minimal, essential code examples
            - Make Rust accessible to non-Rust developers
            - Share the learning journey perspective

            **Steps:**
            1. Check existing posts to avoid duplicate topics
            2. Run `npm run fetch-trends` to see current Rust/systems topics
            3. Pick ONE specific topic that hasn't been covered recently (e.g., "Why Rust", "Memory Safety", "Rust for Web", "Learning Rust", "Performance Optimization", "Rust for Security Tools", etc.)
            4. Write 800-1000 words in the EXACT style of existing posts
            5. Use today's date (get it via `date +%Y-%m-%d` command)

            **Format:**
            - Title: "[Catchy Title with Emoji] ü¶Ä"
            - Date: Use TODAY'S date (run `date +%Y-%m-%d`)
            - Tags: ["rust", "systems-programming", "performance", plus 1-2 specific tags]
            - Filename: `[TODAY]-[slug].md` in `content/posts/` where [TODAY] is today's date

            **Must include:**
            - Funny opening line
            - Personal learning experience or discovery
            - Why developers should care
            - Comparisons with other languages (especially PHP)
            - Practical examples
            - TL;DR or conclusion

            **CRITICAL - Git Operations:**
            After creating the blog post, you MUST:
            1. Run `git add content/posts/[your-new-file].md`
            2. Run `git commit -m "feat: Rust blog - [title]"`
            3. Run `git push origin main`

            Verify the push succeeds before completing!

          # Allow necessary tools for blog generation
          claude_args: |
            --allowedTools "Bash,Write,Read,Grep,Edit,Glob"

  generate-opensource-blog:
    runs-on: ubuntu-latest
    needs: generate-rust-blog
    if: ${{ github.event.inputs.count >= '4' || github.event_name == 'schedule' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Check for existing Open Source blog today
        id: check_existing
        run: |
          TODAY=$(date +%Y-%m-%d)
          if ls content/posts/${TODAY}-*open*source*.md content/posts/${TODAY}-*opensource*.md content/posts/${TODAY}-*github*.md 2>/dev/null | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Open Source blog already exists for today, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Open Source Blog Post
        if: steps.check_existing.outputs.exists != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Generate a fun, engaging blog post about **Open Source, GitHub, or Developer Tools**.

            **AUTHOR CONTEXT - Write as Anuragh K P:**
            - Technical Lead by day, open source contributor by passion
            - 7+ years professional experience in Laravel, AWS, Node.js
            - Active in security communities and open source projects
            - Believes in collaboration to drive innovation
            - Contributes to PHP/Laravel and security-related projects
            - Write from FIRST-PERSON perspective sharing contribution experiences
            - Include phrases like "As a full-time developer who contributes to open source...", "In the security community...", "Balancing work and open source taught me..."

            **CRITICAL: AVOID DUPLICATES**
            1. First, use Glob to list all existing posts in `content/posts/` directory
            2. Look for open source/GitHub posts with similar topics, especially from the last 7 days
            3. If you find similar topics, choose a COMPLETELY DIFFERENT topic
            4. List the recent open source topics you found and explicitly state your chosen topic is different

            **IMPORTANT STYLE REQUIREMENTS:**
            - Read existing posts in `content/posts/` as style references
            - Match the exact conversational, funny tone
            - Use emojis in headings (üåç üöÄ üíª üéâ etc.)
            - Keep it relatable with humor and analogies
            - Short paragraphs, easy to scan
            - Focus on community and contribution stories
            - Share real experiences from contributing

            **Steps:**
            1. Check existing posts to avoid duplicate topics
            2. Run `npm run fetch-trends` to see trending open source projects
            3. Pick ONE specific topic that hasn't been covered recently (e.g., "Getting Started with Open Source", "Cool GitHub Projects", "Maintainer Stories", "Contributing Guide", "Security Tools to Contribute To", etc.)
            4. Write 800-1000 words in the EXACT style of existing posts
            5. Use today's date (get it via `date +%Y-%m-%d` command)

            **Format:**
            - Title: "[Catchy Title with Emoji] üåç"
            - Date: Use TODAY'S date (run `date +%Y-%m-%d`)
            - Tags: ["open-source", "github", "community", plus 1-2 specific tags]
            - Filename: `[TODAY]-[slug].md` in `content/posts/` where [TODAY] is today's date

            **Must include:**
            - Funny opening line
            - Personal contribution story or experience
            - Specific projects/tools to check out
            - How to get involved
            - Lessons learned from community work
            - TL;DR or conclusion

            **CRITICAL - Git Operations:**
            After creating the blog post, you MUST:
            1. Run `git add content/posts/[your-new-file].md`
            2. Run `git commit -m "feat: Open source blog - [title]"`
            3. Run `git push origin main`

            Verify the push succeeds before completing!

          # Allow necessary tools for blog generation
          claude_args: |
            --allowedTools "Bash,Write,Read,Grep,Edit,Glob"
