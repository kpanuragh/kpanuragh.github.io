name: Automated Blog Generation

on:
  schedule:
    # Run daily at 9 AM UTC (can be adjusted to your timezone)
    - cron: '0 9 * * *'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      posts_count:
        description: 'Number of posts to generate'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'
          - '7'
      category:
        description: 'Topic category (leave empty for random)'
        required: false
        type: choice
        options:
          - ''
          - 'backend'
          - 'security'
          - 'cloud'
          - 'devops'
          - 'architecture'
          - 'frontend'
          - 'database'
          - 'languages'
          - 'opensourcesdr'

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate blog posts
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            POSTS_COUNT="${{ github.event.inputs.posts_count }}"
            CATEGORY="${{ github.event.inputs.category }}"
            if [ -z "$CATEGORY" ]; then
              npm run batch-blog -- "$POSTS_COUNT"
            else
              npm run batch-blog -- "$POSTS_COUNT" "$CATEGORY"
            fi
          else
            # Daily scheduled run: generate 2-3 posts
            npm run batch-blog:daily
          fi

      - name: Check for new posts
        id: check_posts
        run: |
          POSTS_DIR="content/posts"
          TODAY=$(date +%Y-%m-%d)
          NEW_POSTS=$(find "$POSTS_DIR" -name "${TODAY}*.md" 2>/dev/null | wc -l)
          echo "new_posts=$NEW_POSTS" >> $GITHUB_OUTPUT
          if [ "$NEW_POSTS" -gt 0 ]; then
            echo "## âœ… Blog Generation Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Posts generated today:** $NEW_POSTS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**New posts:**" >> $GITHUB_STEP_SUMMARY
            find "$POSTS_DIR" -name "${TODAY}*.md" | xargs ls -1 | sed 's|.*\/||' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Pull Request
        if: steps.check_posts.outputs.new_posts > 0
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: |
            feat: Auto-generate blog posts

            Generated ${{ steps.check_posts.outputs.new_posts }} new blog post(s) with Claude API
          title: 'feat: Auto-generated blog posts - ${{ steps.check_posts.outputs.new_posts }} new posts'
          body: |
            ## ðŸ“ Automated Blog Generation

            Generated **${{ steps.check_posts.outputs.new_posts }}** new blog post(s) using Claude API.

            ### Posts Generated
            - See the commit history for details

            ### Checklist
            - [ ] Review content quality
            - [ ] Check for any duplicates or issues
            - [ ] Verify links and code examples
            - [ ] Approve and merge

            _Generated by GitHub Actions_
          branch: auto/blog-generation-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            blog
            ai-generated

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¤– Blog Generation Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_posts.outputs.new_posts }}" -gt 0 ]; then
            echo "âœ… **Success** - Generated ${{ steps.check_posts.outputs.new_posts }} post(s)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **No posts generated** - Check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
