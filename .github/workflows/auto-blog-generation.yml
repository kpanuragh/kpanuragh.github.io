name: Automated Blog Generation (Batch)

on:
  schedule:
    # Run daily at 10 AM UTC
    - cron: '0 10 * * *'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  # Generate 3 different category blogs
  generate-security-blog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Security Blog Post
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Generate one fun, engaging blog post about **Cybersecurity**.

            Pick a SPECIFIC security topic that would be interesting for developers (e.g., "OWASP Top 10", "JWT Security", "API Security", "Docker Security", etc.)

            Return ONLY valid markdown with proper frontmatter (title, date as today, excerpt, tags, featured: true).

            Include:
            - Catchy title with emoji
            - 800-1000 words
            - Conversational tone with humor
            - Code examples (2-3 max)
            - Real-world relevance
            - Call-to-action with social links

            Save to: content/posts/YYYY-MM-DD-slug.md

            Then commit and push:
            - git add content/posts/*.md
            - git commit -m "feat: Security blog - [title]"
            - git push origin main
          claude_args: |
            --allowedTools "Write,Read,Bash,Glob,Grep"

  generate-backend-blog:
    runs-on: ubuntu-latest
    needs: generate-security-blog
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Backend Blog Post
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Generate one fun, engaging blog post about **Node.js, Express, or Backend Development**.

            Pick a SPECIFIC backend topic that's different from recent posts (e.g., "Error Handling", "API Design", "Performance Optimization", "Database Patterns", etc.)

            Return ONLY valid markdown with proper frontmatter (title, date as today, excerpt, tags, featured: true).

            Include:
            - Catchy title with emoji
            - 800-1000 words
            - Conversational tone with humor and analogies
            - Code examples (2-3 max)
            - Practical insights
            - Call-to-action

            Save to: content/posts/YYYY-MM-DD-slug.md

            Then commit and push:
            - git add content/posts/*.md
            - git commit -m "feat: Backend blog - [title]"
            - git push origin main
          claude_args: |
            --allowedTools "Write,Read,Bash,Glob,Grep"

  generate-devops-blog:
    runs-on: ubuntu-latest
    needs: generate-backend-blog
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate DevOps Blog Post
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Generate one fun, engaging blog post about **DevOps, Docker, Kubernetes, or CI/CD**.

            Pick a SPECIFIC DevOps topic that would help developers (e.g., "Docker Best Practices", "GitHub Actions Tips", "Deployment Strategies", "Container Security", etc.)

            Return ONLY valid markdown with proper frontmatter (title, date as today, excerpt, tags, featured: true).

            Include:
            - Catchy title with emoji
            - 800-1000 words
            - Conversational tone with humor
            - Code/config examples (2-3 max)
            - Real-world lessons learned
            - Call-to-action

            Save to: content/posts/YYYY-MM-DD-slug.md

            Then commit and push:
            - git add content/posts/*.md
            - git commit -m "feat: DevOps blog - [title]"
            - git push origin main
          claude_args: |
            --allowedTools "Write,Read,Bash,Glob,Grep"

  summary:
    runs-on: ubuntu-latest
    needs: [generate-security-blog, generate-backend-blog, generate-devops-blog]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Report Results
        run: |
          echo "## ðŸ¤– Automated Blog Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **3 blog posts generated**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          TODAY=$(date +%Y-%m-%d)
          echo "ðŸ“ **Posts from today:**" >> $GITHUB_STEP_SUMMARY
          find content/posts -name "${TODAY}*.md" 2>/dev/null | sed 's|.*\/||' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "- Checking posts..." >> $GITHUB_STEP_SUMMARY
